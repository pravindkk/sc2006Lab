import { NavigationContainer } from "@react-navigation/native";
import { createStackNavigator, HeaderStyleInterpolators } from "@react-navigation/stack";
import React, { useState, useEffect } from 'react'
import { firebase } from './config'
<<<<<<< HEAD
import { StoreUser, GetUser } from "./components/UserComponent";
import { useGlobalState } from "./components/GlobalState";
=======
import { StoreUser } from "./components/UserComponent";
import { putTestDataInDb } from "./components/DataBoilerplate";
>>>>>>> android


import Login from './screens/LoginScreen'
import Register from "./screens/RegisterScreen";
import HomeScreen from "./screens/HomeScreen";
import Header from "./components/Header";
import BottomNavBar from "./components/BottomNavBar";
import ProfileInfoScreen from "./screens/profile/ProfileInfoScreen";
import ChatScreen from "./screens/chat/ChatScreen";
import AllUserScreen from "./screens/chat/AllUserScreen";
import SingleChat from "./screens/chat/SingleChat";


const Stack = createStackNavigator();

/**
 * In this file, set up our app.
 * updateLocalStorage takes our current user's ID and fetches data for our local storage.
 */

 const updateLocalStorage_User = async (uid) => {
  await firebase.firestore().collection('users').doc(uid).get()
  .then(async (snapshot) => {
    if (snapshot.exists) {
      
      loggedInUser = snapshot.data()
      loggedInUser['uid'] = uid;
      await firebase.storage().ref().child('users/' + uid).getDownloadURL().then((res) => {
        loggedInUser['photo'] = res
      })
      
      StoreUser(loggedInUser)
      console.log("Login :" + loggedInUser.photo)
    }
    else {
      console.log("Error! App cannot find user.")
    }
  });
};

const App = () => {
  const [initializing, setInitializing] = useState(true);
  const [startUpOnce, setStartUpOnce] = useState(true);
  const [user, setUser] = useState('');
  const [userData, setUserData] = useState('');
  const [loggedIn, setLoggedIn] = useGlobalState('loggedIn')

<<<<<<< HEAD
  const onAuthStateChanged = async (user) => {
    // if (user.emailVerified) console.log("user is verified");
    // else console.log('user is not verified');

    if (user) {
      setTimeout(async () => {
        await updateLocalStorage(user.uid).then(() => {
          setUser(user);
        });
        
      }, 2000);
      
    }

    if (initalizing) setInitializing(false);

  }

  const updateLocalStorage = async (uid) => {
    await firebase.firestore().collection('users').doc(uid).get()
    .then(async (snapshot) => {
      if (snapshot.exists) {
        
        loggedInUser = snapshot.data()
        loggedInUser['uid'] = uid;
        
        StoreUser(loggedInUser)
        console.log("login :" + loggedInUser.photo)
      }
      else {
        console.log("error app cannot find user")
      }
    })
    
    
=======
  if (startUpOnce)
  {
    //alert("asdsad");
    //putTestDataInDb().catch(_ => alert(_)).then(_ => alert("Test data put in DB."));
    setStartUpOnce(false);
  }

  const updateLocalStorage = async (uid) => {
    //await updateLocalStorage_User(uid); 
>>>>>>> android
  }

  const onAuthStateChanged = async (user) => {
    if (user) {
      setTimeout(async () => await updateLocalStorage(user.uid), 100);
      alert("Logging in!")
      await updateLocalStorage_User();
    }
    setUser(user);
    if (initializing) setInitializing(false);
  }

  const [isSubscriber, setIsSubscriber] = useState(false);
  // Here be dragons!
  useEffect(() => {
<<<<<<< HEAD
    console.log(GetUser());
    // const getLoggedInUser = async () => {
      
    //   const subscriber = await firebase.auth().onAuthStateChanged(onAuthStateChanged);
    //   console.log(subscriber)
    //   return subscriber;
    //   // console.log(user);
    // }
    // getLoggedInUser().catch(console.error)

  }, []);


  // if (initalizing) return null;
=======
    const getLoggedInUser = async () => {
      if (!isSubscriber)
      {
        const unsubscribe = await firebase.auth().onAuthStateChanged(onAuthStateChanged);
        setIsSubscriber(true);
      }
      console.log(unsubscribe)
      return unsubscribe;
      // console.log(user);
    }
    getLoggedInUser().catch(_ => {
      setIsSubscriber(false);
      unsubscribe();
      console.error(_);
    });
  }, []);

  if (initializing) return null;
>>>>>>> android

  if (!loggedIn) {
    return (
      <Stack.Navigator>
        <Stack.Screen
          name="Login"
          component={Login}
          options={{ headerShown: false }}
        />

        <Stack.Screen
          name="Register"
          component={Register}
          options={{ headerShown: false }}
        />
        
      </Stack.Navigator>
    )
  }

  return (
    <Stack.Navigator initialRouteName="BottomNavBar">
      <Stack.Screen
        name="BottomNavBar"
        component={BottomNavBar}
        options={{ headerShown: false }}
      />
      <Stack.Screen name="ChatScreen" component={ChatScreen} options={{headerShown: false}} />
      {/* <Stack.Screen
        name="Chat"
        component={ChatScreen}
        options={{ headerShown: false }}
      /> */}
      <Stack.Screen
        name="AllUsers"
        component={AllUserScreen}
        options={{ headerShown: false }}
      />
      <Stack.Screen
        name="SingleChat"
        component={SingleChat}
        options= {{ headerShown: false }}
      />
      <Stack.Screen
        name="ProfileInfo"
        component={ProfileInfoScreen}
        options={{ headerShown: false }}
      />

      {/* // <BottomNavBar /> */}
    </Stack.Navigator>
  )
}

export default () => {
  return(
    <NavigationContainer>
      <App />
    </NavigationContainer>
  )
}